<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware AI Checkout</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- TensorFlow.js & MobileNet & KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f3f4f6; }
        .camera-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        video {
            /* Note: We keep the transform for the mirror effect, but only apply it 
               if we are using the user-facing camera. If using environment-facing, 
               we typically remove the transform. I will remove the transform here 
               since we are explicitly requesting the environment camera. */
            /* transform: scaleX(-1); */ 
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .overlay-scan {
            position: absolute;
            top: 20%;
            left: 20%;
            right: 20%;
            bottom: 20%;
            border: 2px dashed rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const videoRef = useRef(null);
            const classifier = useRef(null);
            const mobilenetModule = useRef(null);
            
            // State
            const [isModelLoading, setIsModelLoading] = useState(true);
            const [products, setProducts] = useState([]); // List of defined products
            const [cart, setCart] = useState([]);
            const [newProductName, setNewProductName] = useState('');
            const [newProductPrice, setNewProductPrice] = useState('');
            const [prediction, setPrediction] = useState(null); // Current AI guess
            const [mode, setMode] = useState('train'); // 'train' or 'scan'
            const [trainingCount, setTrainingCount] = useState({}); // Track samples per class

            // Initialize AI
            useEffect(() => {
                const loadModel = async () => {
                    console.log('Loading MobileNet...');
                    classifier.current = knnClassifier.create();
                    mobilenetModule.current = await mobilenet.load();
                    setIsModelLoading(false);
                    console.log('Model Loaded');
                };
                loadModel();
                startCamera();
            }, []);

            // Loop for prediction
            useEffect(() => {
                let timer;
                const loop = async () => {
                    if (isModelLoading || !classifier.current || !mobilenetModule.current || !videoRef.current) return;

                    if (classifier.current.getNumClasses() > 0) {
                        try {
                            const activation = mobilenetModule.current.infer(videoRef.current, 'conv_preds');
                            const result = await classifier.current.predictClass(activation);
                            
                            if (result.confidences[result.label] > 0.6) {
                                setPrediction({
                                    label: result.label,
                                    confidence: result.confidences[result.label]
                                });
                            } else {
                                setPrediction(null);
                            }
                        } catch (e) {
                            console.log("Prediction error (likely waiting for video)", e);
                        }
                    }
                    timer = requestAnimationFrame(loop);
                };
                loop();
                return () => cancelAnimationFrame(timer);
            }, [isModelLoading]);

            const startCamera = async () => {
                try {
                    // *** MODIFICATION HERE: Request environment-facing camera ***
                    const constraints = { 
                        video: { 
                            facingMode: { exact: "environment" } 
                        }, 
                        audio: false 
                    };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoRef.current.srcObject = stream;
                    videoRef.current.play();
                } catch (err) {
                    // Fallback in case "environment" isn't supported (e.g., on some laptops)
                    if (err.name === 'NotReadableError' || err.name === 'OverconstrainedError') {
                        console.warn("Could not access environment camera. Falling back to default.");
                         try {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            videoRef.current.srcObject = stream;
                            videoRef.current.play();
                        } catch (fallbackErr) {
                             console.error("Camera access error (even with fallback):", fallbackErr.message);
                             showMessageBox("Error accessing camera: " + fallbackErr.message);
                        }
                    } else {
                        console.error("Camera access error:", err.message);
                        showMessageBox("Error accessing camera: " + err.message);
                    }
                }
            };

            // Custom function to display a message instead of using alert()
            const showMessageBox = (message) => {
                // Since we can't use a full modal component without changing the structure
                // significantly and introducing complex state, we'll log an obvious message
                // and guide the user in the console, as per the rules.
                console.warn("--- SYSTEM MESSAGE BOX ---");
                console.warn(message);
                console.warn("--------------------------");
                // In a production app, this would trigger a custom modal/toast UI.
            };

            const addProductClass = (e) => {
                e.preventDefault();
                if (!newProductName || !newProductPrice) return;
                
                const id = products.length.toString();
                setProducts([...products, {
                    id: id,
                    name: newProductName,
                    price: parseFloat(newProductPrice)
                }]);
                
                setTrainingCount(prev => ({...prev, [id]: 0}));
                setNewProductName('');
                setNewProductPrice('');
            };

            const trainClass = async (classId) => {
                if (!mobilenetModule.current || !classifier.current || !videoRef.current) return;
                
                const activation = mobilenetModule.current.infer(videoRef.current, 'conv_preds');
                classifier.current.addExample(activation, classId);
                
                setTrainingCount(prev => ({
                    ...prev,
                    [classId]: (prev[classId] || 0) + 1
                }));
            };

            const addToCart = () => {
                if (!prediction) return;
                const product = products.find(p => p.id === prediction.label);
                if (product) {
                    setCart([...cart, { ...product, cartId: Date.now() }]);
                }
            };

            const removeFromCart = (cartId) => {
                setCart(cart.filter(item => item.cartId !== cartId));
            };

            const getCartTotal = () => {
                return cart.reduce((total, item) => total + item.price, 0).toFixed(2);
            };

            const getPredictedProduct = () => {
                if (!prediction) return null;
                return products.find(p => p.id === prediction.label);
            };

            const activeProduct = getPredictedProduct();

            return (
                <div className="min-h-screen p-4 md:p-8 font-sans text-slate-800">
                    <header className="mb-6 flex justify-between items-center">
                        <div>
                            <h1 className="text-3xl font-bold text-blue-900">
                                <i className="fa-solid fa-camera-retro mr-2"></i>
                                Smart Hardware POS
                            </h1>
                            <p className="text-slate-500">Non-barcoded item recognition system</p>
                        </div>
                        <div className="bg-white px-4 py-2 rounded-lg shadow-sm">
                            <span className="text-sm font-semibold text-slate-400 uppercase tracking-wider">Status</span>
                            <div className="flex items-center gap-2">
                                <div className={`w-3 h-3 rounded-full ${isModelLoading ? 'bg-yellow-400 animate-pulse' : 'bg-green-500'}`}></div>
                                <span className="font-medium">{isModelLoading ? 'Loading AI Model...' : 'System Ready'}</span>
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* LEFT COLUMN: Camera & Detection */}
                        <div className="lg:col-span-7 flex flex-col gap-6">
                            {/* Camera View */}
                            <div className="bg-black rounded-2xl overflow-hidden shadow-2xl relative aspect-video">
                                {/* Removed the CSS transform: scaleX(-1) to fix mirroring on rear camera */}
                                <video ref={videoRef} className="w-full h-full object-cover" autoPlay playsInline muted></video>
                                
                                {mode === 'scan' && <div className="overlay-scan"></div>}
                                
                                {/* AI Overlay */}
                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent text-white">
                                    {activeProduct ? (
                                        <div className="flex justify-between items-end">
                                            <div>
                                                <p className="text-sm text-gray-300">Identified Item:</p>
                                                <h2 className="text-3xl font-bold text-green-400">{activeProduct.name}</h2>
                                                <p className="font-mono text-xl">${activeProduct.price.toFixed(2)}</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xs text-gray-400">Confidence</div>
                                                <div className="text-lg font-bold">{(prediction.confidence * 100).toFixed(0)}%</div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center text-gray-400 py-2">
                                            {products.length === 0 ? "Add products below to start" : "Searching for items..."}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="bg-white p-4 rounded-xl shadow-md flex justify-center gap-4">
                                <button 
                                    onClick={() => setMode('train')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${mode === 'train' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                >
                                    <i className="fa-solid fa-graduation-cap mr-2"></i> Teach Mode
                                </button>
                                <button 
                                    onClick={() => setMode('scan')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${mode === 'scan' ? 'bg-green-600 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                >
                                    <i className="fa-solid fa-barcode mr-2"></i> Scan Mode
                                </button>
                            </div>

                            {/* Training Area */}
                            {mode === 'train' && (
                                <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                                    <h3 className="text-xl font-bold mb-4">Product Database</h3>
                                    
                                    {/* Add Product Form */}
                                    <form onSubmit={addProductClass} className="flex gap-4 mb-6">
                                        <input 
                                            type="text" 
                                            placeholder="Item Name (e.g., Brass Bolt)" 
                                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={newProductName}
                                            onChange={(e) => setNewProductName(e.target.value)}
                                        />
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            placeholder="Price" 
                                            className="w-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={newProductPrice}
                                            onChange={(e) => setNewProductPrice(e.target.value)}
                                        />
                                        <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-lg font-bold">
                                            Add
                                        </button>
                                    </form>

                                    {/* Product List for Training */}
                                    <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                                        {products.length === 0 && <p className="text-gray-400 text-center italic">No products added yet.</p>}
                                        {products.map((p) => (
                                            <div key={p.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <div>
                                                    <div className="font-bold text-slate-700">{p.name}</div>
                                                    <div className="text-sm text-slate-500">${p.price.toFixed(2)}</div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs font-mono text-gray-400 bg-gray-200 px-2 py-1 rounded">
                                                        {trainingCount[p.id] || 0} samples
                                                    </span>
                                                    <button 
                                                        onMouseDown={() => trainClass(p.id)}
                                                        className="bg-slate-800 active:bg-blue-600 text-white px-4 py-2 rounded shadow hover:shadow-md transition-all select-none"
                                                    >
                                                        <i className="fa-solid fa-camera mr-2"></i> Hold to Train
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="mt-4 text-xs text-gray-400">
                                        * Tip: Hold the "Hold to Train" button while rotating the item in front of the camera to capture different angles.
                                    </p>
                                </div>
                            )}

                            {/* Scanner Action */}
                            {mode === 'scan' && (
                                <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500 flex flex-col items-center justify-center min-h-[200px]">
                                    {activeProduct ? (
                                        <>
                                            <div className="text-4xl text-green-500 mb-2">
                                                <i className="fa-regular fa-circle-check"></i>
                                            </div>
                                            <h3 className="text-2xl font-bold mb-1">Found: {activeProduct.name}</h3>
                                            <p className="text-gray-500 mb-6">Confidence: {(prediction.confidence * 100).toFixed(0)}%</p>
                                            <button 
                                                onClick={addToCart}
                                                className="bg-green-600 hover:bg-green-700 text-white text-lg px-12 py-4 rounded-full shadow-lg transform hover:scale-105 transition-all font-bold"
                                            >
                                                Add to Cart - ${activeProduct.price.toFixed(2)}
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            <div className="animate-spin text-4xl text-gray-300 mb-4">
                                                <i className="fa-solid fa-spinner"></i>
                                            </div>
                                            <p className="text-gray-400 text-lg">Point camera at a trained item...</p>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* RIGHT COLUMN: Cart / Receipt */}
                        <div className="lg:col-span-5">
                            <div className="bg-white rounded-xl shadow-xl h-full flex flex-col overflow-hidden">
                                <div className="bg-slate-800 text-white p-6">
                                    <h2 className="text-2xl font-bold">Current Order</h2>
                                    <p className="text-slate-400 text-sm">Hardware Store POS #001</p>
                                </div>
                                
                                <div className="flex-1 p-6 overflow-y-auto bg-slate-50">
                                    {cart.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-50">
                                            <i className="fa-solid fa-cart-shopping text-6xl mb-4"></i>
                                            <p>Cart is empty</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {cart.map((item) => (
                                                <div key={item.cartId} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center group">
                                                    <div>
                                                        <div className="font-bold text-slate-800">{item.name}</div>
                                                        <div className="text-xs text-gray-400">ID: {item.id}</div>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <span className="font-mono font-bold text-lg">${item.price.toFixed(2)}</span>
                                                        <button 
                                                            onClick={() => removeFromCart(item.cartId)}
                                                            className="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"
                                                        >
                                                            <i className="fa-solid fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="bg-white p-6 border-t border-gray-200">
                                    <div className="flex justify-between items-center mb-6 text-sm text-gray-500">
                                        <span>Items</span>
                                        <span>{cart.length}</span>
                                    </div>
                                    <div className="flex justify-between items-end mb-6">
                                        <span className="text-xl font-bold text-slate-800">Total Due</span>
                                        <span className="text-4xl font-bold text-blue-600">${getCartTotal()}</span>
                                    </div>
                                    <button 
                                        className="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg transition-colors flex justify-center items-center gap-2"
                                        onClick={() => {
                                            if(cart.length > 0) {
                                                // Using showMessageBox instead of alert()
                                                showMessageBox("Order Processed: $" + getCartTotal());
                                                setCart([]);
                                            }
                                        }}
                                    >
                                        <i className="fa-solid fa-check"></i> Complete Sale
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
